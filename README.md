# About

Provides functionality for some of the more tedious requirements when building a Shopify app such as consistent hmac validation behavior for authentication, proxies, etc. Provided as general use functions but can easily be adapted for use as express middleware.

This is not meant to be a _batteries included_ solution. For that checkout [`shopify-express`](https://github.com/Shopify/shopify-express)

# Installation

Note: requires NodeJS >= 8.6.0

`npm install @satel/shopify-app-utils`

or

`yarn add @satel/shopify-app-utils`

# Documentation

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [parseRequest](#parserequest)
    -   [Parameters](#parameters)
    -   [Examples](#examples)
-   [ParsedRequest](#parsedrequest)
    -   [Properties](#properties)
-   [generateRedirect](#generateredirect)
    -   [Parameters](#parameters-1)
    -   [Examples](#examples-1)
-   [computeHMAC](#computehmac)
    -   [Parameters](#parameters-2)
    -   [Examples](#examples-2)
-   [validateAuthHMAC](#validateauthhmac)
    -   [Parameters](#parameters-3)
    -   [Examples](#examples-3)
-   [validateProxyHMAC](#validateproxyhmac)
    -   [Parameters](#parameters-4)
    -   [Examples](#examples-4)
-   [validateDomain](#validatedomain)
    -   [Parameters](#parameters-5)
    -   [Examples](#examples-5)
-   [validateTimestamp](#validatetimestamp)
    -   [Parameters](#parameters-6)
    -   [Examples](#examples-6)
-   [generateJSRedirect](#generatejsredirect)
    -   [Parameters](#parameters-7)

## parseRequest

Parses a url and makes determining the next step more user friendly. Handles validation of shop, hmac, and timestamp

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.url` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.secret` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.margin` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)**  (optional, default `60`)

### Examples

```javascript
const { shop, malformed, fromShopify } = parseRequest({
 url: req.url,
 secret: SHARED_SECRET,
});

if (fromShopify) {
 // App store install or returning user
}

if (shop && !malformed) {
 // Unlisted installation
}

if (!shop && !malformed) {
 // Homepage
}

// etc
```

Returns **[ParsedRequest](#parsedrequest)** 

## ParsedRequest

Type: [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)

### Properties

-   `shop` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `malformed` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 
-   `fromShopify` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## generateRedirect

Generates the url / html based redirect to start the oauth2 process

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.shop` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.apiKey` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.nonce` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.redirect` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.scopes` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** 
    -   `options.online` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**  (optional, default `false`)
    -   `options.iframe` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**  (optional, default `false`)

### Examples

```javascript
// Full Page App
res.redirect(
  generateRedirect({
    shop: 'example.myshopify.com',
    apiKey: 'MY_APP_API_KEY',
    nonce: 'unique-request-identifier',
    redirect: 'https://my-app.com/path/to/redirect',
    scopes: ['read_products', 'write_products', 'etc'],
  }),
);

// Embedded online app
res.send(
  generateRedirect({
    shop: 'example.myshopify.com',
    apiKey: 'MY_APP_API_KEY',
    nonce: 'unique-request-identifier',
    redirect: 'https://my-app.com/path/to/redirect',
    scopes: ['read_products', 'write_products', 'etc'],
    online: true,
    iframe: true,
  }),
);
```

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

## computeHMAC

Produces a hex encoded Sha256 hmac

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.text` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.secret` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### Examples

```javascript
const hash = computeHMAC({
  text: 'message',
  secret: 'hush',
});
```

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

## validateAuthHMAC

-   **See: <https://help.shopify.com/en/api/getting-started/authentication/oauth#verification>**

Parses the url and validates the HMAC provided by shopify

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.url` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.secret` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### Examples

```javascript
// General
const validHMAC = validateAuthHMAC({ url, secret: 'hush' });

// Express
app.use(req => {
  const validHMAC = validateAuthHMAC({ url: req.url, secret: 'hush' });
});
```

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## validateProxyHMAC

-   **See: <https://help.shopify.com/en/api/guides/application-proxies>**

Parses the url and validates proxied requests from Shopify

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.url` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
    -   `options.secret` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### Examples

```javascript
// General
const validHMAC = validateProxyHMAC({ url, secret: 'hush' });

// Express
app.use(req => {
  const validHMAC = validateProxyHMAC({ url: req.url, secret: 'hush' });
});
```

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## validateDomain

Checks if a string is a valid `.myshopify.com` domain (exclude the protocol)

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.shop` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### Examples

```javascript
const validDomain = validateDomain({ shop: 'my-shop.myshopify.com' });
```

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## validateTimestamp

Verifies the shopify timestamp generally provided with authenticated responses from shopify

### Parameters

-   `$0` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.timestamp`  
    -   `$0.margin`   (optional, default `60`)
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
-   `timestamp` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `margin` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Timestamp must be withing margin of now (optional, default `60`)

### Examples

```javascript
const validTimestamp = validateTimestamp({ timestamp: '1533160800', margin: 60 * 5 });
```

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## generateJSRedirect

Pass in a url and it returns an html document that will redirect top rather than the iFrame

### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.url` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
